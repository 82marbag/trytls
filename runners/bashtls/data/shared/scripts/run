#!/bin/sh

stubs=$1      #.stubs file generated by init scripts   (e.g. python3-urllib)
language=$2     #for example python3
run=$3        #what file to run inside the stub folder (e.g. run.py)
backend_conf=$4    #what backend to test to (e.g. badssl_https_conf)
certs=$5           #if no certs, then "_"

processes_min=`exec ps -A --no-headers | wc -l`
stubcount=0

while read -r stub; do  #read next stub

  bash /etc/shared/simplerunner/run "$language" "/etc/shared/stubs/$stub/$run" \
    "/etc/shared/simplerunner/conf/$backend_conf" "$certs" "/etc/shared/simplerunner" $stub &

done <"$stubs"

while true; do
  sleep 1
  processes=`exec ps -A --no-headers | wc -l`
  if [[ $processes == $processes_min ]]; then
    break;
  fi
done


#(( wait_end = stubcount*15 ))  #just a simple timer for now, can be updated
#sleep $wait_end

#bash /etc/shared/stubs/python3-urllib/run.py
