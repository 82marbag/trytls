#!/bin/sh

stubs=$1      #.stubs file generated by init scripts   (e.g. python3-urllib)
language=$2     #for example python3
file=$3        #what file to run inside the stub folder (e.g. run.py)
backend=$4    #what backend to test to (e.g. badssl_https_conf)
certs=$5           #if no certs, then "_"
move=$6
timeout=$7
if [[ ! $timeout || $timeout == "_" ]]; then
  timeout=15
fi

processes_min=`exec ps -A --no-headers | wc -l`

backend=`echo $backend | tr ':' '&'`

while read -r stub; do  #read next stub

  bash '/etc/shared/simplerunner/sr' $certs $language "/etc/shared/simplerunner" "$stub:$file" "$backend" $timeout &

  while [[ `exec ps -A --no-headers | wc -l` -gt 300 ]]; do
    sleep 1
  done

done <"$stubs"

while true; do
  sleep 1
  processes=`exec ps -A --no-headers | wc -l`
  if [[ $processes == $processes_min ]]; then
    break;
  fi
done
